#!/usr/bin/env bash
# Configure /etc/hosts so localhost resolves to 127.0.0.2 and facebook.com to 8.8.8.8

set -euo pipefail

# Re-exec with sudo if not root (needed to write /etc/hosts)
if [ "${EUID:-$(id -u)}" -ne 0 ] && command -v sudo >/dev/null 2>&1; then
  exec sudo bash "$0" "$@"
fi

hosts_file="/etc/hosts"
backup="/etc/hosts.bak.$(date +%s)"

# Backup hosts
cp -f "$hosts_file" "$backup"

# Build a new hosts with the required entries at the top (first match wins)
# Keep the rest of the file intact underneath.
tmp="$(mktemp)"
{
  printf '%s\n' '127.0.0.2 localhost'
  printf '%s\n' '8.8.8.8 facebook.com'
  # Remove any existing exact lines we are adding to avoid duplicates when re-running
  # Then append the original file
  # (Preserve comments and other mappings)
  awk '!( ($1=="127.0.0.2" && $2=="localhost") || ($1=="8.8.8.8" && $2=="facebook.com") ) { print }' "$hosts_file"
} > "$tmp"

# Atomically replace
mv "$tmp" "$hosts_file"

# Show result
echo "Updated $hosts_file (backup: $backup)"
grep -E '^(127\.0\.0\.2\s+localhost|8\.8\.8\.8\s+facebook\.com)' "$hosts_file" || true
